<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat con n8n - Demo</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h2>Chat con n8n</h2>
            <div class="connection-status" id="status">
                <span class="status-indicator"></span>
                <span class="status-text">Conectando...</span>
            </div>
        </div>
        
        <div class="chat-messages" id="messages"></div>
        
        <div class="chat-input-container">
            <div class="file-upload-container">
                <input type="file" id="fileInput" accept="image/*,audio/*" style="display: none;">
                <button class="file-button" id="fileButton"></button>
            </div>
            
            <div class="voice-record-container">
                <button class="voice-button" id="voiceButton"></button>
            </div>
            
            <input type="text" id="messageInput" placeholder="Escribe tu mensaje..." autocomplete="off">
            <button id="sendButton">Enviar</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script type="module">
        import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat@latest/dist/index.js';
        import '/uploads/'; // Placeholder for n8n chat styles
        
        class ChatApp {
            constructor() {
                this.socket = io();
                this.sessionId = 'session-' + Date.now();
                this.isRecording = false;
                this.mediaRecorder = null;
                this.audioChunks = [];
                this.n8nWebhookUrl = 'http://localhost:5678/webhook/chat';
                
                this.initializeElements();
                this.bindEvents();
                this.connectToServer();
                this.initializeN8nChat();
            }
            
            initializeElements() {
                this.messagesContainer = document.getElementById('messages');
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.fileButton = document.getElementById('fileButton');
                this.fileInput = document.getElementById('fileInput');
                this.voiceButton = document.getElementById('voiceButton');
                this.statusIndicator = document.querySelector('.status-indicator');
                this.statusText = document.querySelector('.status-text');
            }
            
            bindEvents() {
                // Enviar mensaje
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
                
                // Subir archivo
                this.fileButton.addEventListener('click', () => this.fileInput.click());
                this.fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
                
                // Grabar audio
                this.voiceButton.addEventListener('click', () => this.toggleRecording());
                
                // Eventos de socket
                this.socket.on('connect', () => this.onConnect());
                this.socket.on('disconnect', () => this.onDisconnect());
                this.socket.on('message', (data) => this.onMessage(data));
                this.socket.on('error', (data) => this.onError(data));
            }
            
            initializeN8nChat() {
                try {
                    // Crear instancia del chat de n8n
                    this.n8nChat = createChat({
                        webhookUrl: this.n8nWebhookUrl,
                        mode: 'window',
                        initialMessages: [
                            { type: 'text', text: '隆Hola! Soy tu asistente de n8n. 驴En qu茅 puedo ayudarte?' }
                        ],
                        metadata: {
                            sessionId: this.sessionId
                        }
                    });
                    
                    console.log('Chat de n8n inicializado');
                } catch (error) {
                    console.error('Error al inicializar chat de n8n:', error);
                    this.addSystemMessage('Error al conectar con n8n, usando modo local', 'warning');
                }
            }
            
            connectToServer() {
                this.statusText.textContent = 'Conectando...';
                this.statusIndicator.classList.remove('connected');
            }
            
            onConnect() {
                this.statusText.textContent = 'Conectado';
                this.statusIndicator.classList.add('connected');
                this.addSystemMessage('Conectado al servidor de chat');
            }
            
            onDisconnect() {
                this.statusText.textContent = 'Desconectado';
                this.statusIndicator.classList.remove('connected');
                this.addSystemMessage('Desconectado del servidor');
            }
            
            async sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message) return;
                
                this.addUserMessage(message);
                
                // Intentar enviar a n8n primero
                if (this.n8nChat) {
                    try {
                        await this.sendToN8n(message);
                    } catch (error) {
                        console.error('Error al enviar a n8n:', error);
                        this.sendViaSocket(message);
                    }
                } else {
                    this.sendViaSocket(message);
                }
                
                this.messageInput.value = '';
                this.showTypingIndicator();
            }
            
            async sendToN8n(message) {
                try {
                    const response = await fetch(this.n8nWebhookUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            sessionId: this.sessionId,
                            attachments: []
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    this.hideTypingIndicator();
                    this.addBotMessage(result.text || result.message || 'Respuesta recibida de n8n');
                    
                } catch (error) {
                    console.error('Error en comunicaci贸n directa con n8n:', error);
                    throw error;
                }
            }
            
            sendViaSocket(message) {
                this.socket.emit('message', {
                    message: message,
                    sessionId: this.sessionId
                });
            }
            
            async handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error('Error al subir archivo');
                    }
                    
                    const result = await response.json();
                    
                    this.addUserMessage(`Archivo enviado: ${result.originalName}`, [{
                        type: result.mimetype.startsWith('image/') ? 'image' : 'audio',
                        url: result.url,
                        originalName: result.originalName,
                        mimetype: result.mimetype
                    }]);
                    
                    this.socket.emit('file', {
                        message: `Archivo: ${result.originalName}`,
                        sessionId: this.sessionId,
                        attachments: [result]
                    });
                    
                    this.showTypingIndicator();
                    
                } catch (error) {
                    this.addSystemMessage(`Error al subir archivo: ${error.message}`, 'error');
                }
                
                this.fileInput.value = '';
            }
            
            async toggleRecording() {
                if (!this.isRecording) {
                    await this.startRecording();
                } else {
                    this.stopRecording();
                }
            }
            
            async startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.mediaRecorder = new MediaRecorder(stream);
                    this.audioChunks = [];
                    
                    this.mediaRecorder.ondataavailable = (event) => {
                        this.audioChunks.push(event.data);
                    };
                    
                    this.mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
                        await this.sendAudioMessage(audioBlob);
                        
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    this.mediaRecorder.start();
                    this.isRecording = true;
                    this.voiceButton.classList.add('recording');
                    this.voiceButton.textContent = '癸';
                    
                } catch (error) {
                    console.error('Error al iniciar grabaci贸n:', error);
                    this.addSystemMessage('No se pudo acceder al micr贸fono', 'error');
                }
            }
            
            stopRecording() {
                if (this.mediaRecorder && this.isRecording) {
                    this.mediaRecorder.stop();
                    this.isRecording = false;
                    this.voiceButton.classList.remove('recording');
                    this.voiceButton.textContent = '';
                }
            }
            
            async sendAudioMessage(audioBlob) {
                const formData = new FormData();
                formData.append('file', audioBlob, `audio-${Date.now()}.webm`);
                
                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error('Error al subir audio');
                    }
                    
                    const result = await response.json();
                    
                    this.addUserMessage('Mensaje de voz', [{
                        type: 'audio',
                        url: result.url,
                        originalName: result.originalName,
                        mimetype: result.mimetype
                    }]);
                    
                    this.socket.emit('file', {
                        message: 'Mensaje de voz',
                        sessionId: this.sessionId,
                        attachments: [result]
                    });
                    
                    this.showTypingIndicator();
                    
                } catch (error) {
                    this.addSystemMessage(`Error al enviar audio: ${error.message}`, 'error');
                }
            }
            
            onMessage(data) {
                this.hideTypingIndicator();
                this.addBotMessage(data.content, data.attachments);
            }
            
            onError(data) {
                this.hideTypingIndicator();
                this.addSystemMessage(data.message, 'error');
            }
            
            addUserMessage(text, attachments = []) {
                this.addMessage(text, 'user', attachments);
            }
            
            addBotMessage(text, attachments = []) {
                this.addMessage(text, 'bot', attachments);
            }
            
            addSystemMessage(text, type = 'info') {
                const messageDiv = document.createElement('div');
                messageDiv.className = `system-message ${type}`;
                messageDiv.textContent = text;
                this.messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }
            
            addMessage(text, sender, attachments = []) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.textContent = text;
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.textContent = new Date().toLocaleTimeString();
                
                messageDiv.appendChild(contentDiv);
                
                attachments.forEach(attachment => {
                    const attachmentDiv = this.createAttachmentElement(attachment, sender);
                    contentDiv.appendChild(attachmentDiv);
                });
                
                messageDiv.appendChild(timeDiv);
                this.messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }
            
            createAttachmentElement(attachment, sender) {
                const attachmentDiv = document.createElement('div');
                attachmentDiv.className = 'file-attachment';
                
                if (attachment.type === 'image') {
                    const img = document.createElement('img');
                    img.src = attachment.url;
                    img.alt = attachment.originalName;
                    img.onclick = () => window.open(attachment.url, '_blank');
                    attachmentDiv.appendChild(img);
                } else if (attachment.type === 'audio') {
                    const audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = attachment.url;
                    attachmentDiv.appendChild(audio);
                }
                
                const fileInfo = document.createElement('div');
                fileInfo.className = 'file-info';
                fileInfo.textContent = attachment.originalName;
                attachmentDiv.appendChild(fileInfo);
                
                return attachmentDiv;
            }
            
            showTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message bot';
                typingDiv.id = 'typing-indicator';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content loading';
                contentDiv.textContent = 'Escribiendo...';
                
                typingDiv.appendChild(contentDiv);
                this.messagesContainer.appendChild(typingDiv);
                this.scrollToBottom();
            }
            
            hideTypingIndicator() {
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }
            
            scrollToBottom() {
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }
        }

        // Inicializar la aplicaci贸n cuando se cargue la p谩gina
        document.addEventListener('DOMContentLoaded', () => {
            new ChatApp();
        });
    </script>
</body>
</html>